<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Share a Confession</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', 'Poppins', sans-serif;
      background: linear-gradient(to bottom right, #f3f8ff, #e6e6ff);
      color: #333;
      margin: 0;
      padding: 20px;
      justify-content: center;
      align-items: center;
      text-align: center;
      position: relative;
      
    }
    h1 {
      color: #4b3f72;
      margin-bottom: 0.5em;
    }
    p {
      max-width: 600px;
      margin: 0 auto 1.5em;
      font-size: 1.1em;
    }
    textarea {
      width: 100%;
      max-width: 500px;
      height: 150px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 15px;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    textarea:focus {
      outline: none;
      border-color: #7868e6;
      box-shadow: 0 0 0 2px rgba(120, 104, 230, 0.2);
    }
    textarea.error {
      border-color: #e74c3c;
      box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);
    }
    textarea.success {
      border-color: #27ae60;
      box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.2);
    }
    .validation-message {
      margin-top: 8px;
      font-size: 0.9em;
      font-weight: 500;
    }
    .validation-message.error {
      color: #e74c3c;
    }
    .validation-message.success {
      color: #27ae60;
    }
    .validation-message.info {
      color: #7868e6;
    }
    .char-counter {
      text-align: right;
      font-size: 0.8em;
      color: #666;
      margin-top: 5px;
    }
    .char-counter.warning {
      color: #f39c12;
    }
    .char-counter.error {
      color: #e74c3c;
    }
    button {
      background-color: #7868e6;
      color: white;
      padding: 10px 25px;
      border: none;
      border-radius: 25px;
      font-size: 1rem;
      margin-top: 15px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }
    button:hover {
      background-color: #5f55c7;
      transform: scale(1.05);
    }
    button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
      transform: none;
    }
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
      color: #2e7d32;
    }
    a.check-link {
      display: block;
      margin-top: 25px;
      color: #4b3f72;
      text-decoration: none;
      font-weight: bold;
    }
    a.check-link:hover {
      text-decoration: underline;
    }
    .floating-verse {
      position: fixed;
      bottom: 10px;
      right: 15px;
      background: #f0f4ff;
      padding: 10px 15px;
      border-radius: 12px;
      font-size: 0.9em;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      color: #4b3f72;
      max-width: 250px;
      animation: fadeInUp 2s ease-out;
    }
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <h1>Let It Out. God is Listening. üïäÔ∏è</h1>
  <p>This is your safe space ‚Äî no names, no shame. Whatever you're carrying, you can lay it down here.
     You are seen. You are loved. And you are not walking alone. We'll respond with love and prayer.
  </p>
  <textarea id="message" placeholder="Speak from your heart. It's safe here, and God understands." autocomplete="off" maxlength="1000"></textarea>
  <div class="char-counter" id="charCounter">0 / 1000 characters</div>
  <div class="validation-message" id="validationMessage"></div>
  <button id="submitBtn">Submit Confession</button>
  <a class="check-link" href="check.html">Already shared something? Click here to check your response üí¨</a>
  <div class="floating-verse">
    "Cast all your anxiety on Him because He cares for you." ‚Äì 1 Peter 5:7
  </div>
  
  <script>
  const firebaseConfig = { 
      apiKey: "AIzaSyDoxfFAq8C0TmxBGDZV6HAmms2px-pWoQc",
      authDomain: "anonymous-confessions-18.firebaseapp.com",
      projectId: "anonymous-confessions-18",
      storageBucket: "anonymous-confessions-18.firebasestorage.app",
      messagingSenderId: "153740861501",
      appId: "1:153740861501:web:c09c7634618ad5feea4a54",
      measurementId: "G-3BY3W357LE"
   };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Validation constants
  const VALIDATION_RULES = {
    MIN_LENGTH: 10,
    MAX_LENGTH: 1000,
    MIN_WORDS: 3
  };

  // DOM elements
  const messageTextarea = document.getElementById('message');
  const submitBtn = document.getElementById('submitBtn');
  const charCounter = document.getElementById('charCounter');
  const validationMessage = document.getElementById('validationMessage');

  // Validation functions
  function validateMessage(message) {
    const errors = [];
    const warnings = [];

    // Check if empty
    if (!message.trim()) {
      errors.push('Please write your confession.');
      return { isValid: false, errors, warnings };
    }

    // Check minimum length
    if (message.trim().length < VALIDATION_RULES.MIN_LENGTH) {
      errors.push(`Your confession should be at least ${VALIDATION_RULES.MIN_LENGTH} characters long.`);
    }

    // Check minimum words
    const wordCount = message.trim().split(/\s+/).filter(word => word.length > 0).length;
    if (wordCount < VALIDATION_RULES.MIN_WORDS) {
      errors.push(`Your confession should contain at least ${VALIDATION_RULES.MIN_WORDS} words.`);
    }

    // Check for excessive whitespace
    if (message.includes('  ')) {
      warnings.push('Consider removing extra spaces.');
    }

    // Check for repetitive characters
    const repetitivePattern = /(.)\1{4,}/;
    if (repetitivePattern.test(message)) {
      warnings.push('Consider reducing repetitive characters.');
    }

    // Check if message is too short for meaningful content
    if (message.trim().length < 20 && wordCount < 5) {
      warnings.push('Consider sharing more details for a meaningful confession.');
    }

    return {
      isValid: errors.length === 0,
      errors,
      warnings
    };
  }

  function updateCharCounter() {
    const length = messageTextarea.value.length;
    const maxLength = VALIDATION_RULES.MAX_LENGTH;
    charCounter.textContent = `${length} / ${maxLength} characters`;
    
    // Update counter color based on usage
    charCounter.className = 'char-counter';
    if (length > maxLength * 0.9) {
      charCounter.classList.add('warning');
    }
    if (length > maxLength * 0.95) {
      charCounter.classList.add('error');
    }
  }

  function updateValidationDisplay(validation) {
    // Clear previous validation state
    messageTextarea.classList.remove('error', 'success');
    validationMessage.className = 'validation-message';
    validationMessage.textContent = '';

    if (!validation.isValid) {
      // Show errors
      messageTextarea.classList.add('error');
      validationMessage.classList.add('error');
      validationMessage.textContent = validation.errors.join(' ');
    } else if (validation.warnings.length > 0) {
      // Show warnings
      validationMessage.classList.add('info');
      validationMessage.textContent = validation.warnings.join(' ');
    } else {
      // Show success
      messageTextarea.classList.add('success');
      validationMessage.classList.add('success');
      validationMessage.textContent = 'Your confession looks good! üíú';
    }
  }

  function updateSubmitButton() {
    const message = messageTextarea.value.trim();
    const validation = validateMessage(message);
    submitBtn.disabled = !validation.isValid;
  }

  // Event listeners
  messageTextarea.addEventListener('input', function() {
    updateCharCounter();
    const validation = validateMessage(this.value);
    updateValidationDisplay(validation);
    updateSubmitButton();
  });

  messageTextarea.addEventListener('blur', function() {
    const validation = validateMessage(this.value);
    updateValidationDisplay(validation);
  });

  submitBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    
    const message = messageTextarea.value.trim();
    const validation = validateMessage(message);
    
    if (!validation.isValid) {
      updateValidationDisplay(validation);
      return;
    }

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.classList.add('loading');
    submitBtn.textContent = 'Submitting...';
    
    try {
      const docRef = await db.collection('confessions').add({
        message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });

      // Save code to localStorage for later checking
      const savedCodes = JSON.parse(localStorage.getItem('savedConfessionCodes') || '[]');
      if (!savedCodes.includes(docRef.id)) {
        savedCodes.push(docRef.id);
        localStorage.setItem('savedConfessionCodes', JSON.stringify(savedCodes));
      }

      window.location.href = `success.html?code=${docRef.id}`;
    } catch (error) {
      // Reset button state
      submitBtn.disabled = false;
      submitBtn.classList.remove('loading');
      submitBtn.textContent = 'Submit Confession';
      
      // Show error message
      validationMessage.className = 'validation-message error';
      validationMessage.textContent = 'Something went wrong. Please try again.';
      console.error(error);
    }
  });

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    updateCharCounter();
    updateSubmitButton();
  });

  // Notification for saved codes with responses
  document.addEventListener('DOMContentLoaded', async function() {
    const savedCodes = JSON.parse(localStorage.getItem('savedConfessionCodes') || '[]');
    if (!savedCodes.length) return;
    let found = false;
    for (const code of savedCodes) {
      try {
        const doc = await db.collection('confessions').doc(code).get();
        if (doc.exists && doc.data().response) {
          found = true;
          const banner = document.createElement('div');
          banner.style = 'background:#e0ffe0;color:#256029;padding:16px 10px;text-align:center;font-size:1.1em;border-radius:12px;margin-bottom:18px;box-shadow:0 2px 8px rgba(60,180,60,0.07);';
          banner.innerHTML = `A response is ready for your confession (code: <b>${code}</b>)! <a href="check.html?code=${code}" style="color:#256029;text-decoration:underline;font-weight:bold;">View Response</a>`;
          document.body.insertBefore(banner, document.body.firstChild);
        }
      } catch (e) {}
    }
  });
</script>
</body>
</html>
