<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin Response Panel</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', 'Poppins', sans-serif;
      background-color: #f9f9ff;
      color: #333;
      margin: 0;
      padding: 20px;
    }

    h1 {
      color: #4b3f72;
      text-align: center;
    }

    .login-container, .filter-container {
      text-align: center;
      margin-bottom: 20px;
    }

    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }

    .error-message {
      color: #e57373;
      font-weight: 500;
      margin-top: 10px;
    }

    .success-message {
      color: #4caf50;
      font-weight: 500;
      margin-top: 10px;
    }

    input[type="email"], input[type="password"] {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin: 5px;
    }

    .confession-card {
      background: white;
      margin: 20px auto;
      padding: 20px;
      border-radius: 15px;
      max-width: 600px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .confession-card h3 {
      color: #4b3f72;
    }

    textarea {
      width: 100%;
      height: 100px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 1rem;
    }

    button {
      margin-top: 10px;
      background-color: #7868e6;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #5f55c7;
    }
  </style>
</head>
<body>
  <h1>Admin Response Panel</h1>

  <div class="login-container" id="loginSection">
    <h2 style="color: #4b3f72; margin-bottom: 20px;">üîê Admin Authentication</h2>
    <p style="color: #666; margin-bottom: 20px; font-size: 0.9rem;">
      This panel is protected by Firebase Custom Claims. Only users with admin privileges can access this area.
    </p>
    <input type="email" id="email" placeholder="Admin Email" style="margin-bottom: 10px;">
    <br>
    <input type="password" id="password" placeholder="Password" style="margin-bottom: 15px;">
    <br>
    <button onclick="login()" style="padding: 12px 30px; font-size: 1rem;">Login as Admin</button>
    <div id="loginError" class="error-message"></div>
    <div id="loginSuccess" class="success-message"></div>
  </div>

  <div id="adminSection" style="display:none">
    <div style="text-align: right; margin-bottom: 20px;">
      <span id="adminUserInfo" style="color: #4b3f72; font-weight: 500; margin-right: 15px;"></span>
      <button onclick="logout()" style="background: #e57373; padding: 8px 16px; font-size: 0.9rem;">Logout</button>
    </div>
    <div class="filter-container">
      <label><input type="checkbox" id="unansweredOnly" onchange="loadConfessions()"> Show only unanswered</label>
    </div>
    <div id="confessionList">Loading confessions...</div>
  </div>

  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyDoxfFAq8C0TmxBGDZV6HAmms2px-pWoQc",
        authDomain: "anonymous-confessions-18.firebaseapp.com",
        projectId: "anonymous-confessions-18",
        storageBucket: "anonymous-confessions-18.firebasestorage.app",
        messagingSenderId: "153740861501",
        appId: "1:153740861501:web:c09c7634618ad5feea4a54",
        measurementId: "G-3BY3W357LE"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Check authentication state and admin claims
    auth.onAuthStateChanged(async user => {
      if (user) {
        try {
          const idTokenResult = await user.getIdTokenResult();
          if (idTokenResult.claims.admin) {
            // ‚úÖ Show admin section
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            
            // Show admin user info
            const adminUserInfo = document.getElementById('adminUserInfo');
            adminUserInfo.textContent = `Admin: ${user.email}`;
            
            loadConfessions();
            console.log('‚úÖ Admin access granted for:', user.email);
                  } else {
          // ‚ùå Access denied - not an admin
          alert("Access denied. You are not an admin.");
          console.log('‚ùå Access denied - user is not admin:', user.email);
          auth.signOut();
          document.getElementById('loginSection').style.display = 'block';
          document.getElementById('adminSection').style.display = 'none';
          document.getElementById('loginError').innerText = "Access denied. Admin privileges required.";
          document.getElementById('loginSuccess').innerText = "";
        }
        } catch (error) {
          console.error('Error checking admin claims:', error);
          alert("Error verifying admin status. Please try again.");
          auth.signOut();
          document.getElementById('loginSection').style.display = 'block';
          document.getElementById('adminSection').style.display = 'none';
          document.getElementById('loginError').innerText = "Error verifying admin status.";
          document.getElementById('loginSuccess').innerText = "";
        }
      } else {
        // User is not logged in
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('adminSection').style.display = 'none';
        document.getElementById('loginError').innerText = "";
        document.getElementById('loginSuccess').innerText = "";
        document.getElementById('adminUserInfo').textContent = "";
      }
    });

    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        document.getElementById('loginError').innerText = "Please enter both email and password.";
        return;
      }
      
      document.getElementById('loginError').innerText = "Logging in...";
      
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          // Auth state listener will handle the rest
          document.getElementById('loginError').innerText = "";
          document.getElementById('loginSuccess').innerText = "Verifying admin privileges...";
        })
        .catch(err => {
          console.error('Login error:', err);
          document.getElementById('loginError').innerText = "Login failed. Please check your credentials.";
        });
    }

    function logout() {
      auth.signOut()
        .then(() => {
          console.log('Admin logged out successfully');
          document.getElementById('loginError').innerText = "";
        })
        .catch(error => {
          console.error('Logout error:', error);
        });
    }

    async function loadConfessions() {
      const filterUnanswered = document.getElementById('unansweredOnly').checked;
      const snapshot = await db.collection("confessions").orderBy("timestamp", "desc").get();
      const confessionList = document.getElementById('confessionList');
      confessionList.innerHTML = '';

      snapshot.forEach(doc => {
        const data = doc.data();
        if (filterUnanswered && data.response) return;

        const card = document.createElement('div');
        card.className = 'confession-card';
        const flagged = data.flagCount && data.flagCount >= 1;
        card.style.border = flagged ? '2px solid #e57373' : '';
        card.innerHTML = `
          <h3>Confession Code: ${doc.id}</h3>
          <p>${data.message}</p>
          <div style=\"margin-bottom:10px;\">
            <strong>Status:</strong> <span id=\"status-${doc.id}\">${data.approved ? 'Approved' : 'Hidden'}</span>
            ${flagged ? `<span style='color:#b91c1c;font-weight:bold;margin-left:12px;'>üö© Flagged (${data.flagCount || 1})</span>` : ''}
          </div>
          <button onclick=\"toggleApproveConfession('${doc.id}', ${!!data.approved})\">${data.approved ? 'Hide' : 'Approve'}</button>
          <button onclick=\"deleteConfession('${doc.id}')\" style=\"background:#e57373;\">Delete</button>
          <textarea id=\"reply-${doc.id}\" placeholder=\"Write a loving, Spirit-led response...\"></textarea>
          <button onclick=\"sendResponse('${doc.id}')\">Send Response</button>
          <div class='admin-comments-section' id='admin-comments-${doc.id}' style='margin-top:18px;'></div>
        `;
        confessionList.appendChild(card);

        // Load comments for this confession
        db.collection('confessions').doc(doc.id).collection('comments').orderBy('timestamp', 'asc').get().then(snap => {
          const commentsDiv = document.getElementById(`admin-comments-${doc.id}`);
          if (!commentsDiv) return;
          if (snap.empty) {
            commentsDiv.innerHTML = "<em style='color:#888;'>No comments yet.</em>";
            return;
          }
          let html = "<strong>Comments:</strong>";
          snap.forEach(commentDoc => {
            const c = commentDoc.data();
            const text = c.text || '';
            const approved = c.approved;
            const time = c.timestamp ? new Date(c.timestamp.toDate()).toLocaleString() : '';
            html += `<div style='margin:8px 0;padding:8px 12px;background:#f8f8ff;border-radius:8px;'>`;
            html += `<span style='color:#4b3f72;font-weight:500;'>Anonymous:</span> ${text}`;
            html += ` <span style='color:#aaa;font-size:0.85em;float:right;'>${time}</span>`;
            if (approved) {
              html += ` <span style='color:#388e3c;font-weight:bold;margin-left:10px;'>[Approved]</span>`;
            } else {
              html += ` <button onclick=\"approveComment('${doc.id}','${commentDoc.id}')\" style=\"background:#81c784;color:#fff;margin-left:10px;\">Approve</button>`;
              html += ` <button onclick=\"deleteComment('${doc.id}','${commentDoc.id}')\" style=\"background:#e57373;color:#fff;margin-left:5px;\">Delete</button>`;
            }
            html += `</div>`;
          });
          commentsDiv.innerHTML = html;
        });
      });
    }

    async function sendResponse(id) {
      const reply = document.getElementById(`reply-${id}`).value.trim();
      if (reply === '') return alert("Please write a response first.");

      await db.collection("confessions").doc(id).update({
        response: reply,
        respondedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Response sent! üïäÔ∏è");
      loadConfessions();
    }

    // Add moderation functions
    window.toggleApproveConfession = async function(id, currentlyApproved) {
      await db.collection("confessions").doc(id).update({ approved: !currentlyApproved });
      document.getElementById(`status-${id}`).innerText = !currentlyApproved ? 'Approved' : 'Hidden';
      loadConfessions();
    }
    window.deleteConfession = async function(id) {
      if (!confirm('Are you sure you want to permanently delete this confession?')) return;
      await db.collection("confessions").doc(id).delete();
      loadConfessions();
    }

    // Add comment moderation functions
    window.approveComment = async function(confessionId, commentId) {
      await db.collection('confessions').doc(confessionId).collection('comments').doc(commentId).update({approved: true});
      loadConfessions();
    }
    window.deleteComment = async function(confessionId, commentId) {
      if (!confirm('Delete this comment?')) return;
      await db.collection('confessions').doc(confessionId).collection('comments').doc(commentId).delete();
      loadConfessions();
    }
  </script>
  
  <script src="script.js"></script>
</body>
</html>
